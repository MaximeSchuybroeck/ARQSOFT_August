@startuml
start
:POST /api/lendings/return\n(by id OR reader+book OR reader+title);
if (Identify active lending) then (by id)
  :repo.findByIdAndReturnedDateIsNull(id);
else (by reader+book)
  :repo.findFirstByReaderEmailAndBookIdAndReturnedDateIsNull(email, bookId);
endif

if (Not found?) then (yes)
  :throw IllegalArgumentException\n("Lending X not found / already returned");
  stop
endif

:mark returnedDate = now;\nrepo.save(lending);

if (recommended param present?) then (yes)
  if (recRepo.existsByLendingId(lending.id)?) then (yes)
    :throw IllegalStateException\n("recommendation already exists");
    stop
  else (no)
    :Build Recommendation\n(sentiment=POSITIVE/NEGATIVE,\ncomment?, bookId, readerEmail, lendingId);\nrecRepo.save(...);
  endif
else (no)
  :skip recommendation;
endif

:Return 200 OK + LendingDTO;

note right
Controller maps errors:
- IllegalArgumentException -> 400
- IllegalStateException  -> 409
end note
stop
@enduml
