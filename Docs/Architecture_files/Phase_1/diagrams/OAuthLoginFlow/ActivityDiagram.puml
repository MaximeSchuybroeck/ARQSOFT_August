@startuml
start
:OAuth2 success event;
:Read provider, email, profile;

if (email or profile missing?) then (yes)
  :HTTP 400 Bad Request;
  stop
endif

:existsByUsername(email)?;
if (no) then (user not found)
  :Create & save new User\n(username, name, iamProvider, default pwd);
endif

:Load user by email;
:Get authorities -> roles;
:Build JWT (issuer="example.io", subject="id,username", roles, exp=3600s);
:Map User -> UserView;
:Return JSON { token, id, userName, fullName };
stop
@enduml
